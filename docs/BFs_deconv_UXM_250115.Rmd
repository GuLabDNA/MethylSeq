---
title: "BFs_deconv_UXM"
author: "Jingru Yu"
date: '2024-12-04'
output: html_document
---

```{r setup}
library(dplyr)
library(magrittr)
library(readr)
library(stringr) #str_split
library(tidyverse) #reduce
library(reshape2)
library(openxlsx)
library(data.table) #detDT
library(scales)
library(writexl) 
library(rstatix) #"adjust_pvalue"
library(Hmisc) #describe

library(ggplot2)
library(ggbreak) #scale_y_break
library(cowplot) #ggdraw, a simple add-on to ggplot
library(ggrepel) #geom_text_repel
library(ggforce) # for 'geom_arc_bar'
library(ggrepel)
library(ggpubr) #ggarrange

library(beeswarm)
library(dichromat)
library(RColorBrewer)
library(ggbeeswarm)

path_up <- "D:/Jingru/deconv/Data/Upload_processed/MethylSeq"

```

#CSF

```{r}
nref=22

#output_test_uxm
res_csfv1 <- read.csv(file=file.path(path_up, "deconv/output_CSFBF_wgbsU250.22ref.csv"),
                   header = TRUE, sep = ",")
#defragment vs. non-defragment, results are the same

samp1 <- as.data.frame(colnames(res_csfv1)[-1])
colnames(samp1) <- "sample_id"
samp2 <- samp1 %>%
  mutate(
         temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         temp4=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1))

samp_csf1 <- read.xlsx(file.path(path_up,"clinical_info/sample_info_clean241204.xlsx"),
                      sheet=2, skipEmptyRows=FALSE, colNames = TRUE)
samp_csf2 <- read.xlsx(file.path(path_up,"clinical_info/sample_info_clean241204.xlsx"),
                      sheet=1, skipEmptyRows=FALSE, colNames = TRUE)
samp_csf2 <- samp_csf2[,c(1,2,3,4,7)]
samp_csf2$Sample_type = "CSF"

samp_csf <- rbind(samp_csf1,samp_csf2)
samp_csfm <- merge(samp_csf[samp_csf$Sample_type=="CSF",],
                   samp2,by.x="TCGA_ID",by.y="temp5",all.x=T)

colnames(samp_csfm)[which(names(samp_csfm)=="temp4")] <- "BF_id"
table(samp_csfm$Sample_type, samp_csfm$TCGA_Project)

diag <- as.data.frame(table(samp_csfm$TCGA_Project))

samp_csfm <- within(samp_csfm, {
  COO <- NA
  COO[TCGA_Project == "LUAD"] <- "Lung-Ep-Alveo"
  COO[TCGA_Project == "BRCA"] <- "Breast-Luminal-Ep"
  COO[TCGA_Project == "PAAD"] <- "Pancreas-Duct"
  COO[TCGA_Project %in% c("DLBCL","B cell lymphoma")] <- "Blood-B"
  COO[TCGA_Project == "STAD"] <- "Gastric-Ep"
  COO[TCGA_Project %in% c("MB","GBM/PXA","GBM","O IDH")] <- "Neuron"
  COO[TCGA_Project == "BLCA"] <- "Bladder-Ep"
  COO[TCGA_Project == "UCS"] <- "Ovary-Ep"
  COO[TCGA_Project == "COAD"] <- "Colon-Ep"
})

co <- samp_csfm[samp_csfm$TCGA_Project=="Control",] 
co_BFid <- na.omit(co$sample_id)
res_csf_neg <- res_csfv1[,which(names(res_csfv1) %in% c("CellType",co_BFid))]

res_csf_chk1 <- rbind(res_csfv1, sum = c(NA,colSums(res_csfv1[,-1]))) #sum=1
res_csf_chk2 <- cbind(res_csf_neg,as.data.frame(rowMeans(res_csf_neg[,-1]))) #mean row =0.05

#wide to long data
se1_long <- melt(setDT(as.data.frame(res_csf_neg)),id.vars = 1, 
                 measure.vars = 2:length(colnames(res_csf_neg)), variable.name = "sample_id")
se1_long2 <- se1_long %>%
  mutate(temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         BF_id=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1),
         perc=round(value*100,4))
table(se1_long2$CellType)
se1_long2 <- se1_long2 %>%
 mutate(ct.f = factor(as.factor(CellType), order=T,
                levels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Colon-Ep","Endothel","Gallbladder","Gastric-Ep",
                         "Head-Neck-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep","Smooth-Musc"),
                labels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Colon-Ep","Endothel","Gallbladder","Gastric-Ep",
                         "Head-Neck-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep","Smooth-Musc")))

tcell <- se1_long2[se1_long2$CellType=="Blood-T",]
p_Tcell <- boxplot(tcell$perc)
IQR <- quantile(tcell$perc, 0.75) - quantile(tcell$perc, 0.25)
lower_bound <- quantile(tcell$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(tcell$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(tcell$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(tcell$perc, 0.75) + 3 * IQR
tcell_out2 <- tcell[tcell$perc < lower_bound2[[1]] | tcell$perc > upper_bound2[[1]],]
print(tcell_out2$temp5)
#"BF3473XR23B"  "BF3514XR23B"  "BF3534XR2122" "BF3607XR2324"

mono <- se1_long2[se1_long2$CellType=="Blood-Mono+Macro",]
p_mono <- boxplot(mono$perc)
IQR <- quantile(mono$perc, 0.75) - quantile(mono$perc, 0.25)
lower_bound <- quantile(mono$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(mono$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(mono$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(mono$perc, 0.75) + 3 * IQR
mono_out2 <- mono[mono$perc < lower_bound2[[1]] | mono$perc > upper_bound2[[1]],]
print(mono_out2$temp5)
#0

granu <- se1_long2[se1_long2$CellType=="Blood-Granul",]
p_granu <- boxplot(granu$perc)
IQR <- quantile(granu$perc, 0.75) - quantile(granu$perc, 0.25)
lower_bound <- quantile(granu$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(granu$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(granu$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(granu$perc, 0.75) + 3 * IQR
granu_out2 <- granu[granu$perc < lower_bound2[[1]] | granu$perc > upper_bound2[[1]],]
print(granu_out2$temp5)
#0

bcell <- se1_long2[se1_long2$CellType=="Blood-B",]
p_bcell <- boxplot(bcell$perc)
IQR <- quantile(bcell$perc, 0.75) - quantile(bcell$perc, 0.25)
lower_bound <- quantile(bcell$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(bcell$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(bcell$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(bcell$perc, 0.75) + 3 * IQR
bcell_out2 <- bcell[bcell$perc < lower_bound2[[1]] | bcell$perc > upper_bound2[[1]],]
print(bcell_out2$temp5)
#0

colon <- se1_long2[se1_long2$CellType=="Colon-Ep",]
p_colon <- boxplot(colon$perc)
IQR <- quantile(colon$perc, 0.75) - quantile(colon$perc, 0.25)
lower_bound <- quantile(colon$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(colon$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(colon$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(colon$perc, 0.75) + 3 * IQR
colon_out2 <- colon[colon$perc < lower_bound2[[1]] | colon$perc > upper_bound2[[1]],]
print(colon_out2$temp5)
# "BF3534XR2122"

gb <- se1_long2[se1_long2$CellType=="Gallbladder",]
p_gb <- boxplot(gb$perc)
IQR <- quantile(gb$perc, 0.75) - quantile(gb$perc, 0.25)
lower_bound <- quantile(gb$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(gb$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(gb$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(gb$perc, 0.75) + 3 * IQR
gb_out2 <- gb[gb$perc < lower_bound2[[1]] | gb$perc > upper_bound2[[1]],]
print(gb_out2$temp5)
#BF3473XR23B"  "BF3534XR2122" "BF3607XR2324"

gastri <- se1_long2[se1_long2$CellType=="Gastric-Ep",]
p_gastri <- boxplot(gastri$perc)
IQR <- quantile(gastri$perc, 0.75) - quantile(gastri$perc, 0.25)
lower_bound <- quantile(gastri$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(gastri$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(gastri$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(gastri$perc, 0.75) + 3 * IQR
gastri_out2 <- gastri[gastri$perc < lower_bound2[[1]] | gastri$perc > upper_bound2[[1]],]
print(gastri_out2$temp5)
#"BF3607XR2324"

liver <- se1_long2[se1_long2$CellType=="Liver-Hep",]
p_liver <- boxplot(liver$perc)
IQR <- quantile(liver$perc, 0.75) - quantile(liver$perc, 0.25)
lower_bound <- quantile(liver$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(liver$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(liver$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(liver$perc, 0.75) + 3 * IQR
liver_out2 <- liver[liver$perc < lower_bound2[[1]] | liver$perc > upper_bound2[[1]],]
print(liver_out2$temp5)
#"BF3473XR23B"  "BF3514XR23B"  "BF3534XR2122" "BF3607XR2324" "BF3641XR2324"

panc <- se1_long2[se1_long2$CellType=="Pancreas-Duct",]
p_panc <- boxplot(panc$perc)
IQR <- quantile(panc$perc, 0.75) - quantile(panc$perc, 0.25)
lower_bound <- quantile(panc$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(panc$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(panc$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(panc$perc, 0.75) + 3 * IQR
panc_out2 <- panc[panc$perc < lower_bound2[[1]] | panc$perc > upper_bound2[[1]],]
print(panc_out2$temp5)
#"BF3534XR2122"

kid <- se1_long2[se1_long2$CellType=="Kidney-Ep",]
p_kid <- boxplot(kid$perc)
IQR <- quantile(kid$perc, 0.75) - quantile(kid$perc, 0.25)
lower_bound <- quantile(kid$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(kid$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(kid$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(kid$perc, 0.75) + 3 * IQR
kid_out2 <- kid[kid$perc < lower_bound2[[1]] | kid$perc > upper_bound2[[1]],]
print(kid_out2$temp5)
#0

oligo <- se1_long2[se1_long2$CellType=="Oligodend",]
p_oligo <- boxplot(oligo$perc)
IQR <- quantile(oligo$perc, 0.75) - quantile(oligo$perc, 0.25)
lower_bound <- quantile(oligo$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(oligo$perc, 0.75) + 1.5 * IQR
lower_bound2 <- quantile(oligo$perc, 0.25) - 3 * IQR
upper_bound2 <- quantile(oligo$perc, 0.75) + 3 * IQR
oligo_out2 <- oligo[oligo$perc < lower_bound2[[1]] | oligo$perc > upper_bound2[[1]],]
print(oligo_out2$temp5)
#"BF3514XR23B"  "BF3534XR2122" "BF3607XR2324"

out <- unique(c(tcell_out2$temp5, bcell_out2$temp5, mono_out2$temp5, 
                granu_out2$temp5, kid_out2$temp5, liver_out2$temp5, 
                panc_out2$temp5, gastri_out2$temp5, oligo_out2$temp5, 
                gb_out2$temp5, colon_out2$temp5))
# "BF3473XR23B"  "BF3514XR23B"  "BF3534XR2122" "BF3607XR2324" "BF3641XR2324"

res_csf_neg.filter1 <- res_csf_neg %>% dplyr::select(-all_of(tcell_out2$sample_id))
res_csf_neg.filter2 <- res_csf_neg 

#others

immune_df <- rbind(tcell,granu,bcell,mono)

# Beeswarm plot by group
# pdf(file=file.path(pathsampout, "Output_BFs", 
#                    paste0(str_sub(Sys.Date(), start = 3), "-",
#                           "BoxPlot_50CSF.co_4immune.pdf")), 
#     width = 4, height = 5, useDingbats = FALSE)
# par(mar = c(8, 4, 1, 2))
boxplot(perc ~ CellType, data=immune_df, lwd=0.7,
        xlab = NA, xaxt='n', ylab = "Fraction (%)", ylim =c(0,100), boxwex=.5, las=2)
tick <- seq_along(names(table(immune_df$CellType)))
axis(side=1, at = tick, labels = FALSE)
text(tick, -25, names(table(immune_df$CellType)), srt = 45, xpd = TRUE,cex.axis=1.5)
title(main = "Immune cells in CSF controls")
beeswarm(data=immune_df, perc ~ CellType,
         pch = 16, col = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"),
         priority = "density",corral = "wrap",
         xlab = NA, xaxt='n', ylab = "Fraction (%)",add=TRUE)
#dev.off()  

# pdf(file=file.path(pathsampout, "Output_BFs", 
#                    paste0(str_sub(Sys.Date(), start = 3), "-",
#                           "BoxPlot_50CSF.co_20cts.pdf")), 
#     width = 9, height = 5, useDingbats = FALSE)
# par(mar = c(8.5, 4, 1, 2))
boxplot(perc ~ CellType, data=se1_long2, lwd=0.7,
        xlab = NA, ylab = "Fraction (%)", ylim =c(0,100), boxwex=.7, las=2)
title(main = paste0(nref," potential cell types in CSF controls"))
beeswarm(data=se1_long2, perc ~ CellType,
         pch = 16,cex=0.6,priority = "density",corral = "wrap",
         xlab = NA, ylab = "Fraction (%)",add=TRUE)
#dev.off()  

```

  "BF3079XR21B_comb.hg38_PE.dedup_sorted","BF3123XR21B_comb.hg38_PE.dedup_sorted",
  "BF3219XR21B_comb.hg38_PE.dedup_sorted","BF3382XR21B_comb.hg38_PE.dedup_sorted",
  "BF3385XR21B_comb.hg38_PE.dedup_sorted","BF3460XR21B_comb.hg38_PE.dedup_sorted",
  "BF3472XR21B_comb.hg38_PE.dedup_sorted","BF3474XR21B_comb.hg38_PE.dedup_sorted",
  "BF3255XR21B_comb.hg38_PE.dedup_sorted",
  "BF3270XR2122_comb.hg38_PE.dedup_sorted","BF3353XR2122_comb.hg38_PE.dedup_sorted",
  "BF3635XR21B_comb.hg38_PE.dedup_sorted","BF3647XR21B_comb.hg38_PE.dedup_sorted",
  "BF3648XR21B_comb.hg38_PE.dedup_sorted","BF3667XR21B_comb.hg38_PE.dedup_sorted",
  "BF3683XR21B_comb.hg38_PE.dedup_sorted"
  
```{r cases}
##############

res_csf_ca <- res_csfv1[,-which(names(res_csfv1) %in% colnames(res_csf_neg)[-1])]

samp_csf_ca <- samp_csfm %>%
  filter(!sample_id %in% colnames(res_csf_neg)[-1])

colMax <- function(data) sapply(data, max, na.rm = TRUE)
colSort <- function(data, ...) sapply(data, sort, ...)

res_csf_chk1 <- rbind(res_csf_ca, sum = c(NA,colSums(res_csf_ca[,-1]))) #sum=1
res_csf_chk2 <- cbind(res_csf_ca,as.data.frame(rowMeans(res_csf_ca[,-1]))) #mean row =0.05

ex_col <- c("CellType",samp_csf_ca$sample_id)
res_csf_ca2 <- as.data.frame(res_csf_ca)[1:nref,ex_col]

#wide to long data
ca_long <- melt(setDT(as.data.frame(res_csf_ca2)),id.vars = 1, 
                 measure.vars = 2:length(colnames(res_csf_ca2)), variable.name = "sample_id")
ca_long2 <- ca_long %>%
  mutate(temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         BF_id=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1),
         perc=round(value*100,4))

ca_long2 <- ca_long2 %>%
 mutate(
        ct.f = factor(as.factor(CellType), order=T,
                levels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Colon-Ep","Endothel","Gallbladder","Gastric-Ep",
                         "Head-Neck-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep","Smooth-Musc"),
                labels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Colon-Ep","Endothel","Gallbladder","Gastric-Ep",
                         "Head-Neck-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep","Smooth-Musc")))

```

# CSF controls

```{r Z score, allcells}
# shows the statistician how different a piece of data is from the average for the set.
# assign a Z score against all normal controls 
# Z-score = (x - μ) / σ, (samp_perc% - control_perc_mean%)/(control_std) 
# then rank all Z scores by highest to lowest

##########################################
#CSF controls
res_csf_neg.filter1$mean <- rowMeans(res_csf_neg.filter1[,-1])
res_csf_neg.filter1$std <- apply(res_csf_neg.filter1[,-1], 1,sd)
se1 <- res_csf_neg.filter1[,c("CellType","mean","std")]
colnames(se1) <- c("CellType","mean1","std1")

res_csf_neg.filter2$mean <- rowMeans(res_csf_neg.filter2[,-1])
res_csf_neg.filter2$std <- apply(res_csf_neg.filter2[,-1], 1,sd)
se2 <- res_csf_neg.filter2[,c("CellType","mean","std")]
colnames(se2) <- c("CellType","mean2","std2")
se_m <- merge(se1,se2,by="CellType")
se_m <- se_m %>% 
  mutate(diff_mean=mean1-mean2,
         diff_sd=std1-std2)

##########################################
res_csf_neg.filter <- res_csf_neg.filter1

```
# Deconv result output

```{r}
ct <- res_csf_neg.filter$CellType

#case
blk <- data.frame()
for(i in 1:length(ct)){
  ca_long_ex <- ca_long2[,c("CellType","sample_id","BF_id","value")] %>% 
  filter(CellType==ct[i]) %>%
  rowwise()%>%
  mutate(control_mean=res_csf_neg.filter[res_csf_neg.filter$CellType==ct[i],"mean"],
         control_std=res_csf_neg.filter[res_csf_neg.filter$CellType==ct[i],"std"],
         z.score=round((value-control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score")]

  blk <- rbind(blk, ca_long_ex)
}

samp <- unique(samp_csf_ca$BF_id)

#top1, may have high immune background and endo
blk_deconv <- data.frame()

for (i in 1:length(samp)){
samp_ex <- blk[blk$BF_id==samp[i],]
samp_ex2 <- as.data.frame(samp_ex)
a <-samp_ex2$z.score
samp_ex3 <- cbind(samp_ex2[,c("CellType","BF_id","value")],a)
colnames(samp_ex3) <- c("CellType","BF_id","cell_prop","z.score")
samp_ex3$cell_prop <- percent(samp_ex3$cell_prop,accuracy=1)
samp_ex3 <- samp_ex3[order(-samp_ex3$z.score),]
samp_ex3_top3.lab <- samp_ex3[1:3,1]
samp_ex3_top3.score <- samp_ex3[1:3,4]

samp_ex3_top3.txt <- paste0(samp_ex3_top3.lab,"_",samp_ex3_top3.score)
  
coo_label <- samp_csfm[samp_csfm$BF_id==samp[i],"COO"]
diag_label <- samp_csfm[samp_csfm$BF_id==samp[i],"TCGA_Project"]
match <- ifelse(coo_label %in% samp_ex3_top3.lab, "match", "not match")
coo_prop <- ifelse(match=="match",samp_ex3[samp_ex3$CellType==coo_label,3],NA)
# Create a text
df_deconv <-data.frame(
  BF_id=samp[i],Path_diag=diag_label,COO=coo_label,
  if_match=match, deconv_prop=coo_prop,
  top1_deconv=samp_ex3_top3.txt[1],
  top2_deconv=samp_ex3_top3.txt[2],
  top3_deconv=samp_ex3_top3.txt[3])

blk_deconv <- rbind(blk_deconv,df_deconv)
}

# write_xlsx(blk_deconv[,1:8], 
#            file.path("decov_CSF.56ca_temp_v2.xlsx"),
#            col_names = TRUE, format_headers = TRUE)

# deconv results in the excel file
ca_deconv1 <- blk_deconv[,1:8]

```

# CSF Normalization

```{r z-score,lung/non-lung}

luad_id <- samp_csfm[samp_csfm$TCGA_Project=="LUAD","BF_id"]
brca_id <- samp_csfm[samp_csfm$TCGA_Project=="BRCA","BF_id"]
lympho_id <- samp_csfm[samp_csfm$TCGA_Project=="DLBC","BF_id"]
coad_id <- samp_csfm[samp_csfm$TCGA_Project=="COAD","BF_id"]
stad_id <- samp_csfm[samp_csfm$TCGA_Project=="STAD","BF_id"]
ov_id <- samp_csfm[samp_csfm$TCGA_Project=="OV","BF_id"]
oligo_id <- samp_csfm[samp_csfm$TCGA_Project %in% 
                        c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"]
neuron_id <- samp_csfm[samp_csfm$TCGA_Project %in% 
                         c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"]


samp_res_csf.ca <- samp_csfm[samp_csfm$TCGA_Project!="Control",]
ca_long2_csf <- ca_long2[ca_long2$BF_id %in% samp_res_csf.ca$BF_id,]
table(ca_long2_csf$CellType)

ct <- names(unlist(table(ca_long2$CellType)))


ca_long2_csf_or <- ca_long2_csf %>%
  group_by(BF_id) %>%
  arrange(BF_id, -value) %>%
  mutate(or_perc = row_number())

blk <- data.frame()
for(i in 1:length(ct)){
  ca_long_ex <- ca_long2_csf_or[,c("CellType","sample_id","BF_id","value","or_perc")] %>% 
  filter(CellType==ct[i]) %>%
  rowwise()%>%
  mutate(control_mean=res_csf_neg.filter[res_csf_neg.filter$CellType==ct[i],"mean"],
         control_std=res_csf_neg.filter[res_csf_neg.filter$CellType==ct[i],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score","or_perc")]

  blk <- rbind(blk, ca_long_ex)
}

a <- blk$z.score
ca_long_ex2 <- cbind(blk[,c("CellType","BF_id","value","or_perc")],a)
colnames(ca_long_ex2) <- c("CellType","BF_id","value","or_perc","z.score")

ca_long_ex2_or <- ca_long_ex2 %>%
    group_by(BF_id) %>%
    arrange(-z.score, .by_group = TRUE)  %>%
  mutate(or_zscore=c(1:nref))


ca_long_ex3 <- ca_long_ex2_or[ca_long_ex2_or$CellType %in% ct, ] %>%
  mutate(or_perc2=ifelse(or_perc>2,0,or_perc),
         or_perc2.f= factor(as.factor(or_perc2)),
    grp_luad =ifelse(BF_id %in% luad_id, yes="LUAD", no="Non-LUAD"),
          grp_brca =ifelse(BF_id %in% brca_id, yes="BRCA", no="Non-BRCA"),
          grp_lympho =ifelse(BF_id %in% lympho_id, yes="DLBC", no="Non-DLBC"), #lympho_id/2
          grp_coad =ifelse(BF_id %in% coad_id, yes="COAD", no="Non-COAD"),
          grp_stad =ifelse(BF_id %in% stad_id, yes="STAD",no="Non-STAD"),
          grp_ov =ifelse(BF_id %in% ov_id, yes="OV/UCS", no="Non-OV/UCS"),
          grp_oligo =ifelse(BF_id %in% oligo_id, yes="Brain",no="Non-Brain"),
          grp_neuron =ifelse(BF_id %in% neuron_id, yes="Brain",no="Non-Brain"),

          grp_luad.f=factor(as.factor(grp_luad), order=T,
                levels=c("LUAD", "Non-LUAD"),
                labels=c("LUAD", "Non-LUAD")),
          grp_brca.f=factor(as.factor(grp_brca), order=T,
                levels=c("BRCA", "Non-BRCA"),
                labels=c("BRCA", "Non-BRCA")),
          grp_lympho.f=factor(as.factor(grp_lympho), order=T,
                levels=c("DLBC", "Non-DLBC"),
                labels=c("DLBC", "Non-DLBC")),
          grp_coad.f=factor(as.factor(grp_coad), order=T,
                levels=c("COAD", "Non-COAD"),
                labels=c("COAD", "Non-COAD")),
          grp_stad.f=factor(as.factor(grp_stad), order=T,
                levels=c("STAD", "Non-STAD"),
                labels=c("STAD", "Non-STAD")),
          grp_ov.f=factor(as.factor(grp_ov), order=T,
                levels=c("OV/UCS", "Non-OV/UCS"),
                labels=c("OV/UCS", "Non-OV/UCS")),
          grp_oligo.f=factor(as.factor(grp_oligo), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")),
          grp_neuron.f=factor(as.factor(grp_neuron), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")))


# Get the first three values per group
ca_long3top <- ca_long_ex2_or %>%
  group_by(BF_id) %>%
  slice_head(n = 3)

# Summarize the first three values per group
ca_sum <- ca_long3top %>%
  group_by(BF_id) %>%
  summarise(
    sum_value = sum(z.score))

ca_long_ex2_orRatio <- merge(ca_long_ex2_or, ca_sum,by="BF_id",all.x=T)

ca_long_ex2_orRatio <- ca_long_ex2_orRatio %>%
    group_by(BF_id) %>%
  mutate(z.score_ratio=round(z.score/sum_value,3)) %>% 
    arrange(-z.score_ratio, .by_group = TRUE)  %>%
  mutate(or_zscore_ratio=c(1:nref))

ca_long_exRatio <- ca_long_ex2_orRatio[ca_long_ex2_orRatio$CellType %in% ct, ] %>%
  mutate(or_perc2=ifelse(or_perc>2,0,or_perc),
         or_perc2.f= factor(as.factor(or_perc2)),
    grp_luad =ifelse(BF_id %in% luad_id, yes="LUAD", no="Non-LUAD"),
          grp_brca =ifelse(BF_id %in% brca_id, yes="BRCA", no="Non-BRCA"),
          grp_lympho =ifelse(BF_id %in% lympho_id, yes="DLBC", no="Non-DLBC"), #lympho_id/2
          grp_coad =ifelse(BF_id %in% coad_id, yes="COAD", no="Non-COAD"),
          grp_stad =ifelse(BF_id %in% stad_id, yes="STAD",no="Non-STAD"),
          grp_ov =ifelse(BF_id %in% ov_id, yes="OV/UCS", no="Non-OV/UCS"),
          grp_oligo =ifelse(BF_id %in% oligo_id, yes="Brain",no="Non-Brain"),
          grp_neuron =ifelse(BF_id %in% neuron_id, yes="Brain",no="Non-Brain"),

          grp_luad.f=factor(as.factor(grp_luad), order=T,
                levels=c("LUAD", "Non-LUAD"),
                labels=c("LUAD", "Non-LUAD")),
          grp_brca.f=factor(as.factor(grp_brca), order=T,
                levels=c("BRCA", "Non-BRCA"),
                labels=c("BRCA", "Non-BRCA")),
          grp_lympho.f=factor(as.factor(grp_lympho), order=T,
                levels=c("DLBC", "Non-DLBC"),
                labels=c("DLBC", "Non-DLBC")),
          grp_coad.f=factor(as.factor(grp_coad), order=T,
                levels=c("COAD", "Non-COAD"),
                labels=c("COAD", "Non-COAD")),
          grp_stad.f=factor(as.factor(grp_stad), order=T,
                levels=c("STAD", "Non-STAD"),
                labels=c("STAD", "Non-STAD")),
          grp_ov.f=factor(as.factor(grp_ov), order=T,
                levels=c("OV/UCS", "Non-OV/UCS"),
                labels=c("OV/UCS", "Non-OV/UCS")),
          grp_oligo.f=factor(as.factor(grp_oligo), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")),
          grp_neuron.f=factor(as.factor(grp_neuron), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")))
```

# Make boxplots separately

```{r boxplots_LUAD/DLBC/BRCA}
###############################
#luad
lung1 <- ca_long_ex3 %>% filter(CellType=="Lung-Ep-Alveo")  

p_luad <- ggplot(data=lung1, aes(x = grp_luad.f, y = z.score, 
                                 color = grp_luad.f)) + 
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3, priority = "density", corral = "wrap") + #
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#b890e0","grey60"))+
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Lung alveolar epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_luad

p_luad_or <- ggplot(data=lung1, aes(x = or_zscore, y = z.score, 
                                 color = grp_luad.f)) + 
  geom_point(size=1.8) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#b890e0","grey60"))+
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5,nref, by = 5),nref),
                     labels=c(1,2,3,seq(5,nref, by = 5),nref),
                     limits=c(0.5,nref+0.5), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Lung alveolar epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_luad_or

###################################
#brca
brca1 <- ca_long_ex3 %>% filter(CellType=="Breast-Luminal-Ep")
table(brca1$grp_brca.f)

p_brca <- ggplot(data=brca1, aes(x = grp_brca.f, y = z.score, 
                                 color = grp_brca.f)) + 
  geom_boxplot() + 
  geom_beeswarm(cex=3, priority = "density", corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#6e1e33","grey60"))+
  # scale_y_continuous(breaks=seq(-100,400, by = 100),
  #                    labels=seq(-100,400, by = 100),
  #                    limits=c(-100,405), expand=c(0,0)) +
   scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Breast luminal epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_brca

p_brca_or <- ggplot(data=brca1, aes(x = or_zscore, y = z.score, 
                                 color = grp_brca.f)) + 
  geom_point(size=1.8) +
  #annotate("point", x = 3, y = 1.165, colour = "#6e1e33", shape=4, size=2) +
  #geom_vline(xintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#6e1e33","grey50"))+
  # scale_y_continuous(breaks=seq(-100,400, by = 100),
  #                    labels=seq(-100,400, by = 100),
  #                    limits=c(-100,405), expand=c(0,0)) +
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5,nref, by = 5),nref),
                     labels=c(1,2,3,seq(5,nref, by = 5),nref),
                     limits=c(0.5,nref+0.5), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Breast luminal epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_brca_or

###################################
#DLBC
lympho1 <- ca_long_ex3 %>% filter(CellType=="Blood-B") 

p_lympho <- ggplot(data=lympho1, aes(x = grp_lympho.f, y = z.score, 
                                     color = grp_lympho.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=4, priority = "density", corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#e4703a","grey60"))+
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="B cell")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_lympho

p_lympho_or <- ggplot(data=lympho1, aes(x = or_zscore, y = z.score, 
                                 color = grp_lympho.f)) + 
  geom_point(size=1.8) +
  #annotate("point", x = 2, y = 4.968, colour = "#e4703a", shape=4, size=2) +
  #geom_vline(xintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#e4703a","grey60"))+
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5, nref, by = 5), nref),
                     labels=c(1,2,3,seq(5, nref, by = 5), nref),
                     limits=c(0.5, nref+0.5), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="B cell")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_lympho_or

###################################
neuron1 <- ca_long_ex3 %>% filter(CellType=="Neuron") 

p_neuron <- ggplot(data=neuron1, aes(x = grp_neuron.f, y = z.score, 
                                     color = grp_neuron.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3, priority = "density", corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#68ab97","grey60"))+
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Neuron")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 

p_neuron_or <- ggplot(data=neuron1, aes(x = or_zscore, y = z.score, 
                                 color = grp_neuron.f)) + 
  geom_point(size=1.8) +
  #annotate("point", x = 2, y = 4.968, colour = "#e4703a", shape=4, size=2) +
  #geom_vline(xintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#68ab97","grey60"))+ #"#00BFC4"
  scale_y_continuous(breaks=c(-10,0,20,40),
                     labels=c(-10,0,20,40),
                     limits=c(-10,42), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5, nref, by = 5), nref),
                     labels=c(1,2,3,seq(5, nref, by = 5), nref),
                     limits=c(0.5, nref+0.5), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Neuron")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_neuron_or

```
# More boxplots
```{r boxplots_other_cancers}

###################################
oligo1 <- ca_long_ex3 %>% filter(CellType=="Oligodend") 

p_oligo <- ggplot(data=oligo1, aes(x = grp_oligo.f, y = z.score, 
                                     color = grp_oligo.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=4, priority = "density", corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#00BFC4","grey60"))+
  scale_y_continuous(breaks=c(-10,0,25,50),
                     labels=c(-10,0,25,50),
                     limits=c(-10,52), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Oligodend.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 

###################################
stad1 <- ca_long_ex3 %>% filter(CellType=="Gastric-Ep") 

p_stad <- ggplot(data=stad1, aes(x = grp_stad.f, y = z.score, 
                                     color = grp_stad.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=4, corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#f79246","grey60"))+
  scale_y_continuous(breaks=c(-10,0,25,50),
                     labels=c(-10,0,25,50),
                     limits=c(-10,52), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Gastric epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_stad
###################################
coad1 <- ca_long_ex3 %>% filter(CellType=="Colon-Ep") 

p_coad <- ggplot(data=coad1, aes(x = grp_coad.f, y = z.score, 
                                     color = grp_coad.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=4, corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#ad6ef1","grey60"))+
  scale_y_continuous(breaks=c(-10,0,25,50),
                     labels=c(-10,0,25,50),
                     limits=c(-10,52), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Colon epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_coad
###################################
ov1 <- ca_long_ex3 %>% filter(CellType=="Ovary-Ep") 

p_ov <- ggplot(data=ov1, aes(x = grp_ov.f, y = z.score, 
                                     color = grp_ov.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=4, corral = "wrap") +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#0581be","grey60"))+
  scale_y_continuous(breaks=c(-10,0,25,50),
                     labels=c(-10,0,25,50),
                     limits=c(-10,52), expand=c(0,0)) +
  labs(y="Z-score (with CSF controls)",x=NULL,title="Ovary epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(linewidth=1.1,color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=0,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_ov
```

# Supplementary boxplots

## Boxplots of all cell types

```{r boxplot_allcts}
ca_long_Zcsf <- merge(ca_long_ex2,samp_res_csf.ca[,c("BF_id","TCGA_Project")])
ca_long_Zcsf <- ca_long_Zcsf %>% 
  mutate(TCGA_Project1 = ifelse(TCGA_Project %in% 
    c("MCF GBM","MCF IDH GLM","MCF MB G3G4"),
    "Brain",(ifelse(TCGA_Project=="OV","OV/UCS",TCGA_Project))))

col_code <- c("BRCA"="#b90f38","COAD"="#ad6ef1",
        "DLBC"="#e4703a","LUAD"="#b890e0","Brain"="#55c056", 
        "STAD"="#f79246","OV/UCS"="#6da7d9")

##############
p_all1 <- ggplot(data=ca_long_Zcsf, aes(x = TCGA_Project1, y = z.score, 
                                     color = TCGA_Project1)) +
  geom_boxplot() + 
  ggbeeswarm::geom_beeswarm(cex =0.8, size =0.5) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  #scale_color_brewer(palette="Set1")+
  scale_colour_manual(values = col_code) +
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  facet_wrap(~ CellType, ncol = 4) +
  labs(y="Z score",x=NULL)+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=10.5,face="bold",angle=90,hjust=1,vjust=0.5),
        axis.text.y = element_text(size=12, face="bold"),
        axis.title=element_text(size=12,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        #plot.title = element_text(face= "bold",size=12,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_all1

# pdf(file=file.path(pathcsf, "Output", 
#     paste0(str_sub(Sys.Date(), start = 3),
#     "-CSF.zscore.20cts.56samples_ref.controls_combBrain_swarmplot_uxm.pdf")), 
#     width = 5.5, height = 10, useDingbats = FALSE)
# p_all1
# dev.off()

```

## CSF normalization, background of non-target cancers

```{r change_background_normalization}

luad_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="LUAD","BF_id"] #20
brca_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="BRCA","BF_id"] #6
lympho_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="DLBC","BF_id"] #21

coad_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="COAD","BF_id"] #1
stad_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="STAD","BF_id"]#1
ov_id <- 
  samp_csfm[samp_csfm$TCGA_Project=="OV","BF_id"]#1
oligo_id <- 
  samp_csfm[samp_csfm$TCGA_Project %in% c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"] #6
neuron_id <- 
  samp_csfm[samp_csfm$TCGA_Project %in% c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"] #6

table(samp_csfm$TCGA_Project)

samp_res_csf.ca <- samp_csfm[samp_csfm$TCGA_Project!="Control",]
ca_long2_csf <- ca_long2[ca_long2$BF_id %in% samp_res_csf.ca$BF_id,]


ct_list <- list(list("LUAD","Lung-Ep-Alveo",luad_id),
                list("DLBC","Blood-B",lympho_id),
                list("BRCA","Breast-Luminal-Ep",brca_id),
                list("Brain","Neuron",neuron_id))

blk <- data.frame()
for(i in 1:length(ct_list)){
  
ref_names <- 
  as.vector(samp_res_csf.ca[!samp_res_csf.ca$BF_id %in% ct_list[[i]][[3]], "sample_id"])

ref_use <-subset(res_csf_ca2, select=c("CellType",ref_names))

ref_use$mean <- rowMeans(ref_use[,-1])
ref_use$std <- apply(ref_use[,-1], 1,sd)

  ca_long_ex <- ca_long2_csf[,c("CellType","sample_id","BF_id","value")] %>% 
  filter(CellType==ct_list[[i]][[2]]) %>%
  rowwise()%>%
  mutate(control_mean=ref_use[ref_use$CellType==ct_list[[i]][[2]],"mean"],
         control_std=ref_use[ref_use$CellType==ct_list[[i]][[2]],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score")]

a <- ca_long_ex$z.score
ca_long_ex2 <- cbind(ca_long_ex[,c("CellType","BF_id","value")],a)
colnames(ca_long_ex2) <- c("CellType","BF_id","value","z.score")
ca_long_ex2$grp <- 
  ifelse(ca_long_ex2$BF_id %in% ct_list[[i]][[3]],
         ct_list[[i]][[1]],paste0("Non-",ct_list[[i]][[1]]))

ca_long_ex3 <- ca_long_ex2[ca_long_ex2$BF_id %in% ct_list[[i]][[3]],]


blk <- rbind(blk, ca_long_ex3)
}

zscore_ref.nontarget <- blk %>%
  mutate(grp.f=factor(as.factor(grp), order=T,
                levels=c("LUAD","DLBC","BRCA","Brain"),
                labels=c("LUAD\n(Lung alveolar epi.)","DLBC\n(B cell)",
                         "BRCA\n(breast luminal epi.)","Brain\n(neuron)")))

  
p_ref <- ggplot(data=zscore_ref.nontarget, aes(x = grp.f, y = z.score, 
                                     color = grp.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(priority = "density", dodge.width=0.9) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#b890e0","#e4703a","#b90f38","#006ead"))+
  scale_y_continuous(breaks=seq(-5,30, by = 5),
                     labels=seq(-5,30, by = 5),
                     limits=c(-5,30)) +
  labs(y="Z score",x=NULL)+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=45,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_ref
```
```{r boxplots_non-targets}
#FUNCTION to get z-scores  
zscore_ref.nontargetCan <- function(ct_all, id_list, can_tp){
blk <- data.frame()
for(i in 1:length(ct_all)){
  
ref_names <- 
  as.vector(samp_res_csf.ca[!samp_res_csf.ca$BF_id %in% id_list, "sample_id"])

ref_use <-subset(res_csf_ca2, select=c("CellType",ref_names))

ref_use$mean <- rowMeans(ref_use[,-1])
ref_use$std <- apply(ref_use[,-1], 1,sd)

  ca_long_ex <- ca_long2_csf[,c("CellType","sample_id","BF_id","value")] %>% 
  filter(CellType==ct_all[i]) %>%
  rowwise()%>%
  mutate(control_mean=ref_use[ref_use$CellType==ct_all[i],"mean"],
         control_std=ref_use[ref_use$CellType==ct_all[i],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score")]

a <- ca_long_ex$z.score
ca_long_ex2 <- cbind(ca_long_ex[,c("CellType","BF_id","value")],a)
colnames(ca_long_ex2) <- c("CellType","BF_id","value","z.score")
ca_long_ex2$grp <- 
  ifelse(ca_long_ex2$BF_id %in% id_list,
         can_tp,paste0("Non-",can_tp))

ca_long_ex3 <- ca_long_ex2[ca_long_ex2$BF_id %in% id_list,]


blk <- rbind(blk, ca_long_ex3)
}
return(blk)
}

ct_all <- names(unlist(table(ca_long2$CellType)))

luad_df <- zscore_ref.nontargetCan(ct_all, id_list=luad_id, can_tp="LUAD")
brca_df <- zscore_ref.nontargetCan(ct_all, id_list=brca_id, can_tp="BRCA")
lympho_df <- zscore_ref.nontargetCan(ct_all, id_list=lympho_id, can_tp="DLBC")
coad_df <- zscore_ref.nontargetCan(ct_all, id_list=coad_id, can_tp="COAD")
neuron_df <- zscore_ref.nontargetCan(ct_all, id_list=neuron_id, can_tp="Brain")
#oligo_df <- zscore_ref.nontargetCan(ct_all, id_list=oligo_id, can_tp="Brain")
stad_df <- zscore_ref.nontargetCan(ct_all, id_list=stad_id, can_tp="STAD")
ov_df <- zscore_ref.nontargetCan(ct_all, id_list=ov_id, can_tp="OV")

m_df <- rbind(luad_df,brca_df,lympho_df,coad_df,neuron_df,stad_df,ov_df)
m_df$grp <- ifelse(m_df$grp=="OV","OV/UCS",m_df$grp)

col_code2 <- c("BRCA"="#b90f38","COAD"="#ad6ef1",
        "DLBC"="#e4703a","LUAD"="#b890e0","Brain"="#55c056", 
        #"MCF IDH GLM"="#ecbf00", "MCF MB G3G4"="#0581be",
        "STAD"="#f79246","OV/UCS"="#6da7d9")

p_all2 <- ggplot(data=m_df, aes(x = grp, y = z.score, 
                                     color = grp)) +
  geom_boxplot() + 
  ggbeeswarm::geom_beeswarm(cex =0.8, size =0.5) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  #scale_color_brewer(palette="Set1")+
  scale_colour_manual(values = col_code2) +
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  facet_wrap(~ CellType, ncol = 4) +
  labs(y="Z score",x=NULL)+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=10.5,face="bold",angle=90,hjust=1,vjust=0.5),
        axis.text.y = element_text(size=12, face="bold"),
        axis.title=element_text(size=12,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        #plot.title = element_text(face= "bold",size=12,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_all2
```
