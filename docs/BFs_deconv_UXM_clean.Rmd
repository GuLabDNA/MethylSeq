---
title: "BFs_deconv_UXM"
author: "Jingru Yu"
date: '2023-12-04'
output: html_document

Update: '2024-07-02'

##Aim: 1) check deconvolution results of CSF negative controls and cases
##2) use Z scores to show the difference between cases and controls (negative/non-target cancers)

---

```{r, warning=FALSE}
#rm(list=ls())
library(dplyr)
library(readr)
library(stringr) #str_split
library(openxlsx)
library(data.table) #detDT
library(scales)
library(writexl) 
library(Hmisc) #describe

library(ggplot2)
library(ggbreak) #scale_y_break
library(ggrepel) #geom_text_repel
library(ggforce) # for 'geom_arc_bar'
library(ggpubr) #ggarrange
library(beeswarm)
library(RColorBrewer)
library(ggbeeswarm)

# RMSE = √[ Σ(Pi – Oi)2 / n ]
GetRMSE <- function(data_se,ct_se, method_se){
# function
rmse2 <- function(preds, actuals, na.rm = TRUE){
  res <- sqrt(mean((preds-actuals)^2, na.rm = na.rm))
  return(res)
}

se1 <- data_se %>% filter(grp==ct_se, method==method_se)
rmse_res = rmse2(preds=se1$Predicted/100, actuals=se1$Actual/100)
rmse_res = round(unique(rmse_res),3)
print(rmse_res)
return(rmse_res)
}

```

# CSF samples

```{r negative controls}
pathpro <-"D:/Jingru/deconv/Data/Upload_processed" 

res_csfv1 <- read.csv(file=file.path(pathpro, "deconv",
                                     "output_169BF_ca.co_20ref.csv"),
                   header = TRUE, sep = ",")

samp1 <- as.data.frame(colnames(res_csfv1)[-1])
colnames(samp1) <- "sample_id"
samp2 <- samp1 %>%
  mutate(
         temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         temp4=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1))

samp_all <- read.xlsx(file.path(pathpro,"clinical_info/206samples_all_clin_clean.xlsx"),
                      sheet=1, skipEmptyRows=FALSE, colNames = TRUE)
samp_csf1 <- samp_all[samp_all$Sample_type=="CSF",]

samp_csfm <- merge(samp_csf1[samp_csf1$Run=="x",],samp2,by.x="BF_id",by.y="temp4",all.x=T)
table(samp_csfm$Run)

diag <- as.data.frame(table(samp_csfm$Path_diagnosis))

samp_csfm <- within(samp_csfm, {
  COO <- NA
  COO[Path_diagnosis == "BRCA"] <- "Breast-Luminal-Ep"
  COO[Path_diagnosis == "PAAD"] <- "Pancreas-Duct"
  COO[Path_diagnosis %in% c("DLBCL","B cell lymphoma")] <- "Blood-B"
  COO[Path_diagnosis == "STAD"] <- "Gastric-Ep"
  COO[Path_diagnosis %in% c("MB","GBM/PXA","GBM","O IDH")] <- "Neuron"
  COO[Path_diagnosis == "BLCA"] <- "Bladder-Ep"
  COO[Path_diagnosis == "OV/UCS"] <- "Ovary-Ep"
  COO[Path_diagnosis == "COAD"] <- "Colon-Ep"
  COO[Path_diagnosis == "LUAD"] <- "Lung-Ep-Alveo"

})

co <- samp_csfm[samp_csfm$Path_diagnosis=="Control",] 
co_BFid <- na.omit(co$sample_id)
res_csf_neg <- res_csfv1[,which(names(res_csfv1) %in% c("CellType",co_BFid))]

res_csf_chk1 <- rbind(res_csfv1, sum = c(NA,colSums(res_csfv1[,-1]))) #sum=1
res_csf_chk2 <- cbind(res_csf_neg,as.data.frame(rowMeans(res_csf_neg[,-1]))) #mean row =0.05

#wide to long data
se1_long <- melt(setDT(as.data.frame(res_csf_neg)),id.vars = 1, 
                 measure.vars = 2:length(colnames(res_csf_neg)), variable.name = "sample_id")
se1_long2 <- se1_long %>%
  mutate(temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         BF_id=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1),
         perc=round(value*100,4))

table(se1_long2$CellType) 
se1_long2 <- se1_long2 %>%
 mutate(ct.f = factor(as.factor(CellType), order=T,
                levels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Smooth-Musc","Colon-Ep",
                         "Endothel","Gastric-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep"),
                labels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Smooth-Musc","Colon-Ep",
                         "Endothel","Gastric-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep")))


```

# Check outliers

```{r boxplot_outlier}
tcell <- se1_long2[se1_long2$CellType=="Blood-T",]
p_Tcell <- boxplot(tcell$perc)
IQR <- quantile(tcell$perc, 0.75) - quantile(tcell$perc, 0.25)
lower_bound <- quantile(tcell$perc, 0.25) - 1.5 * IQR
upper_bound <- quantile(tcell$perc, 0.75) + 1.5 * IQR
tcell_outliers <- tcell[tcell$perc < lower_bound[[1]] | tcell$perc > upper_bound[[1]],]
print(tcell_outliers$sample_id)
#"BF3473XR23B"  "BF3514XR23B"  "BF3534XR2122" "BF3607XR2324" "BF3641XR2324"

res_csf_neg.filter1 <- res_csf_neg %>% dplyr::select(-all_of(tcell_outliers$sample_id))
res_csf_neg.filter2 <- res_csf_neg 

#others
granu <- se1_long2[se1_long2$CellType=="Blood-Granul",]
p_granu <- boxplot(granu$perc) #no outlier

Bcell <- se1_long2[se1_long2$CellType=="Blood-B",]
p_Bcell <- boxplot(Bcell$perc) #no outlier

Mono <- se1_long2[se1_long2$CellType=="Blood-Mono+Macro",]
p_Mono <- boxplot(Mono$perc) #no outlier

immune_df <- rbind(tcell,granu,Bcell,Mono)

# Beeswarm plot by group
boxplot(perc ~ CellType, data=se1_long2, lwd=0.7,
        xlab = NA, ylab = "Fraction (%)", ylim =c(0,100), boxwex=.7, las=2)
title(main = "20 potential cell types in CSF controls")
beeswarm(data=se1_long2, perc ~ CellType,
         pch = 16,cex=0.6,priority = "density",corral = "wrap",
         xlab = NA, ylab = "Fraction (%)",add=TRUE)
abline(h = 5, col = "gray50", lwd = 2, lty = 4) 
```

  "BF3079XR21B_comb.hg38_PE.dedup_sorted","BF3123XR21B_comb.hg38_PE.dedup_sorted",
  "BF3219XR21B_comb.hg38_PE.dedup_sorted","BF3382XR21B_comb.hg38_PE.dedup_sorted",
  "BF3385XR21B_comb.hg38_PE.dedup_sorted","BF3460XR21B_comb.hg38_PE.dedup_sorted",
  "BF3472XR21B_comb.hg38_PE.dedup_sorted","BF3474XR21B_comb.hg38_PE.dedup_sorted",
  "BF3255XR21B_comb.hg38_PE.dedup_sorted",
  "BF3270XR2122_comb.hg38_PE.dedup_sorted","BF3353XR2122_comb.hg38_PE.dedup_sorted",
  "BF3635XR21B_comb.hg38_PE.dedup_sorted","BF3647XR21B_comb.hg38_PE.dedup_sorted",
  "BF3648XR21B_comb.hg38_PE.dedup_sorted","BF3667XR21B_comb.hg38_PE.dedup_sorted",
  "BF3683XR21B_comb.hg38_PE.dedup_sorted"

# CSF cases

```{r cases}
##############
res_csf_ca <- res_csfv1[,-which(names(res_csfv1) %in% colnames(res_csf_neg)[-1])]

samp_csf_ca <- samp_csfm %>%
  filter(!sample_id %in% colnames(res_csf_neg)[-1])

colMax <- function(data) sapply(data, max, na.rm = TRUE)
colSort <- function(data, ...) sapply(data, sort, ...)

res_csf_chk1 <- rbind(res_csf_ca, sum = c(NA,colSums(res_csf_ca[,-1]))) #sum=1
res_csf_chk2 <- cbind(res_csf_ca,as.data.frame(rowMeans(res_csf_ca[,-1]))) #mean row =0.05

ex_col <- c("CellType",samp_csf_ca$sample_id)
res_csf_ca2 <- as.data.frame(res_csf_ca)[1:20,ex_col]

#wide to long data
ca_long <- melt(setDT(as.data.frame(res_csf_ca2)),id.vars = 1, 
                 measure.vars = 2:length(colnames(res_csf_ca2)), variable.name = "sample_id")
ca_long2 <- ca_long %>%
  mutate(temp1=sapply(str_split(sample_id, "X",  n = 2), `[`, 1),
         temp2=ifelse(str_sub(temp1,-1,-1)=="v", as.numeric(gsub("\\D", "", temp1)),
                      substring(temp1, 3)),
         temp3=substr(sample_id,1,2),
         BF_id=paste0(temp3,temp2),
         temp5=sapply(str_split(sample_id, "_",  n = 2), `[`, 1),
         perc=round(value*100,4))

ca_long2 <- ca_long2 %>%
 mutate(
        ct.f = factor(as.factor(CellType), order=T,
                levels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Smooth-Musc","Colon-Ep",
                         "Endothel","Gastric-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep"),
                labels=c("Blood-B","Blood-Granul","Blood-Mono+Macro","Blood-T",
                         "Breast-Basal-Ep","Breast-Luminal-Ep","Bladder-Ep",
                         "Smooth-Musc","Colon-Ep",
                         "Endothel","Gastric-Ep","Kidney-Ep","Liver-Hep","Lung-Ep-Alveo",
                         "Lung-Ep-Bron","Neuron","Oligodend","Ovary-Ep",
                         "Pancreas-Duct","Small-Int-Ep")))

```

# CSF controls

```{r Z score, allcells}
# shows the statistician how different a piece of data is from the average for the set.
# assign a Z score against all normal controls 
# Z-score = (x - μ) / σ, (samp_perc% - control_perc_mean%)/(control_std) 
# then rank all Z scores by highest to lowest

res_csf_neg.filter1$mean <- rowMeans(res_csf_neg.filter1[,-1])
res_csf_neg.filter1$std <- apply(res_csf_neg.filter1[,-1], 1,sd)
se1 <- res_csf_neg.filter1[,c("CellType","mean","std")]
colnames(se1) <- c("CellType","mean1","std1")

res_csf_neg.filter2$mean <- rowMeans(res_csf_neg.filter2[,-1])
res_csf_neg.filter2$std <- apply(res_csf_neg.filter2[,-1], 1,sd)
se2 <- res_csf_neg.filter2[,c("CellType","mean","std")]
colnames(se2) <- c("CellType","mean2","std2")
se_m <- merge(se1,se2,by="CellType")
se_m <- se_m %>% 
  mutate(diff_mean=mean1-mean2,
         diff_sd=std1-std2)
#if we do not remove 5 extremes, z-scores will be smaller

res_csf_neg.filter <- res_csf_neg.filter1
ct <- res_csf_neg.filter$CellType
```

##Boxplots of z-scores, cancers vs. non-target cancers

```{r boxplot, LUAD&DLBC&BRCA}

table(samp_csfm$Diag_TCGA)
cnv_neg <- samp_csfm[samp_csfm$WGS_CNV_call=="-" & samp_csfm$Diag_TCGA!="Control","BF_id"]
luad_id <- samp_csfm[samp_csfm$Diag_TCGA=="LUAD","BF_id"]
brca_id <- samp_csfm[samp_csfm$Diag_TCGA=="BRCA","BF_id"]
lympho_id <- samp_csfm[samp_csfm$Diag_TCGA=="DLBC","BF_id"]
lympho_id2 <- samp_csfm[samp_csfm$Diag_TCGA=="DLBC" & samp_csfm$WGS_CNV_call=="+","BF_id"]
coad_id <- samp_csfm[samp_csfm$Diag_TCGA=="COAD","BF_id"]
stad_id <- samp_csfm[samp_csfm$Diag_TCGA=="STAD","BF_id"]
ov_id <- samp_csfm[samp_csfm$Diag_TCGA=="OV","BF_id"]
oligo_id <- samp_csfm[samp_csfm$Diag_TCGA %in% 
                        c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"]
neuron_id <- samp_csfm[samp_csfm$Diag_TCGA %in% 
                         c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"]

samp_res_csf.ca <- samp_csfm[samp_csfm$Diag_TCGA!="Control",]
ca_long2_csf <- ca_long2[ca_long2$BF_id %in% samp_res_csf.ca$BF_id,]

ct=c("Breast-Luminal-Ep","Lung-Ep-Alveo","Blood-B","Colon-Ep","Gastric-Ep",
     "Ovary-Ep","Oligodend","Neuron")

ct_all <- c("Breast-Luminal-Ep","Lung-Ep-Alveo","Blood-B","Colon-Ep",
     "Gastric-Ep","Ovary-Ep","Oligodend","Neuron",
     "Endothel","Bladder-Ep","Breast-Basal-Ep","Kidney-Ep", "Liver-Hep",
     "Lung-Ep-Bron","Pancreas-Duct", "Small-Int-Ep", "Smooth-Musc",
     "Blood-Granul", "Blood-Mono+Macro","Blood-T")

ca_long2_csf_or <- ca_long2_csf %>%
  group_by(BF_id) %>%
  arrange(BF_id, -value) %>%
  mutate(or_perc = row_number())

blk <- data.frame()
for(i in 1:length(ct_all)){
  ca_long_ex <- ca_long2_csf_or[,c("CellType","sample_id","BF_id","value","or_perc")] %>% 
  filter(CellType==ct_all[i]) %>%
  rowwise()%>%
  mutate(control_mean=res_csf_neg.filter[res_csf_neg.filter$CellType==ct_all[i],"mean"],
         control_std=res_csf_neg.filter[res_csf_neg.filter$CellType==ct_all[i],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score","or_perc")]

  blk <- rbind(blk, ca_long_ex)
}

a <- blk$z.score
ca_long_ex2 <- cbind(blk[,c("CellType","BF_id","value","or_perc")],a)
colnames(ca_long_ex2) <- c("CellType","BF_id","value","or_perc","z.score")

ca_long_ex2_or <- ca_long_ex2 %>%
    group_by(BF_id) %>%
    arrange(-z.score, .by_group = TRUE)  %>%
  mutate(or_zscore=c(1:20))

ca_long_ex3 <- ca_long_ex2_or[ca_long_ex2_or$CellType %in% ct, ] %>%
  mutate(or_perc2=ifelse(or_perc>2,0,or_perc),
         or_perc2.f= factor(as.factor(or_perc2)),
    grp_luad =ifelse(BF_id %in% luad_id, yes="LUAD", no="Non-LUAD"),
          grp_brca =ifelse(BF_id %in% brca_id, yes="BRCA", no="Non-BRCA"),
          grp_lympho =ifelse(BF_id %in% lympho_id, yes="DLBC", no="Non-DLBC"), #lympho_id/2
          grp_coad =ifelse(BF_id %in% coad_id, yes="COAD", no="Non-COAD"),
          grp_stad =ifelse(BF_id %in% stad_id, yes="STAD",no="Non-STAD"),
          grp_ov =ifelse(BF_id %in% ov_id, yes="OV/UCS", no="Non-OV/UCS"),
          grp_oligo =ifelse(BF_id %in% oligo_id, yes="Brain",no="Non-Brain"),
          grp_neuron =ifelse(BF_id %in% neuron_id, yes="Brain",no="Non-Brain"),

          grp_luad.f=factor(as.factor(grp_luad), order=T,
                levels=c("LUAD", "Non-LUAD"),
                labels=c("LUAD", "Non-LUAD")),
          grp_brca.f=factor(as.factor(grp_brca), order=T,
                levels=c("BRCA", "Non-BRCA"),
                labels=c("BRCA", "Non-BRCA")),
          grp_lympho.f=factor(as.factor(grp_lympho), order=T,
                levels=c("DLBC", "Non-DLBC"),
                labels=c("DLBC", "Non-DLBC")),
          grp_coad.f=factor(as.factor(grp_coad), order=T,
                levels=c("COAD", "Non-COAD"),
                labels=c("COAD", "Non-COAD")),
          grp_stad.f=factor(as.factor(grp_stad), order=T,
                levels=c("STAD", "Non-STAD"),
                labels=c("STAD", "Non-STAD")),
          grp_ov.f=factor(as.factor(grp_ov), order=T,
                levels=c("OV/UCS", "Non-OV/UCS"),
                labels=c("OV/UCS", "Non-OV/UCS")),
          grp_oligo.f=factor(as.factor(grp_oligo), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")),
          grp_neuron.f=factor(as.factor(grp_neuron), order=T,
                levels=c("Brain", "Non-Brain"),
                labels=c("Brain", "Non-Brain")))


###################################
#luad
lung1 <- ca_long_ex3 %>% filter(CellType=="Lung-Ep-Alveo")  

p_luad <- ggplot(data=lung1, aes(x = grp_luad.f, y = z.score, 
                                 color = grp_luad.f, shape = grp_luad.f)) + 
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#b890e0","#00BFC4"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Lung alveolar epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_luad
  
p_luad_or <- ggplot(data=lung1, aes(x = or_zscore, y = z.score, 
                                 color = grp_luad.f, shape = grp_luad.f)) + 
  geom_point(size=1.8) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#b890e0","#00BFC4"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5,20, by = 5)),
                     labels=c(1,2,3,seq(5,20, by = 5)),
                     limits=c(0.5,21), expand=c(0,0)) +
  labs(y="Z-score",x=NULL,title="Lung alveolar epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_luad_or
  
###################################
#brca
brca1 <- ca_long_ex3 %>% filter(CellType=="Breast-Luminal-Ep")

p_brca <- ggplot(data=brca1, aes(x = grp_brca.f, y = z.score, 
                                 color = grp_brca.f, shape=grp_brca.f)) + 
  geom_boxplot() + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#6e1e33","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Breast luminal epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_brca

p_brca_or <- ggplot(data=brca1, aes(x = or_zscore, y = z.score, 
                                 color = grp_brca.f, shape= grp_brca.f)) + 
  geom_point(size=1.8) +
  annotate("point", x = 3, y = 1.165, colour = "#6e1e33", shape=4, size=2) +
  #geom_vline(xintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#6e1e33","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5,20, by = 5)),
                     labels=c(1,2,3,seq(5,20, by = 5)),
                     limits=c(0.5,21), expand=c(0,0)) +
  labs(y="Z-score",x=NULL,title="Breast luminal epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_brca_or

###################################
#DLBC
lympho1 <- ca_long_ex3 %>% filter(CellType=="Blood-B") 

p_lympho <- ggplot(data=lympho1, aes(x = grp_lympho.f, y = z.score, 
                                     color = grp_lympho.f, shape=grp_lympho.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#e4703a","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="B cell")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_lympho

p_lympho_or <- ggplot(data=lympho1, aes(x = or_zscore, y = z.score, 
                                 color = grp_lympho.f, shape= grp_lympho.f)) + 
  geom_point(size=1.8) +
  annotate("point", x = 2, y = 4.968, colour = "#e4703a", shape=4, size=2) +
  #geom_vline(xintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#e4703a","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40), expand=c(0,0)) +
  scale_x_continuous(breaks=c(1,2,3,seq(5,20, by = 5)),
                     labels=c(1,2,3,seq(5,20, by = 5)),
                     limits=c(0.5,21), expand=c(0,0)) +
  labs(y="Z-score",x=NULL,title="B cell")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold"),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_lympho_or

###################################
#merge
remove_y <- theme(
  axis.text.y = element_blank(),
  #axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)

pbox1 <- list(p_luad,
             p_lympho + remove_y, 
             p_brca + remove_y)

pbox1_m <- ggarrange(plotlist = pbox1, ncol = 3, nrow = 1, 
                    common.legend = F, legend= NULL,  widths = c(1.4, 1.1,1.1))
pbox1_m

pbox_or <- list(p_luad_or,
             p_lympho_or + remove_y, 
             p_brca_or + remove_y)

pbox1_or <- ggarrange(plotlist = pbox_or, ncol = 3, nrow = 1, 
                    common.legend = F, legend= NULL,  widths = c(1.4, 1.1,1.1))
pbox1_or

```

# Extended Data Fig., 
##Boxplots of other tumors

```{r}
###################################
#COAD
coad1 <- ca_long_ex3 %>% filter(CellType=="Colon-Ep") 

p_coad <- ggplot(data=coad1, aes(x = grp_coad.f, y = z.score, 
                                     color = grp_coad.f, shape=grp_coad.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#ad6ef1","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Colon epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 

###################################
#STAD
stad1 <- ca_long_ex3 %>% filter(CellType=="Gastric-Ep") 

p_stad <- ggplot(data=stad1, aes(x = grp_stad.f, y = z.score, 
                                     color = grp_stad.f, shape=grp_stad.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#f79246","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Gastric epi.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 

###################################
#OV
ov1 <- ca_long_ex3 %>% filter(CellType=="Ovary-Ep") 

p_ov <- ggplot(data=ov1, aes(x = grp_ov.f, y = z.score, 
                                     color = grp_ov.f, shape=grp_ov.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#0581be","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Ovary epi./Endom.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 


###################################
oligo1 <- ca_long_ex3 %>% filter(CellType=="Oligodend") 

p_oligo <- ggplot(data=oligo1, aes(x = grp_oligo.f, y = z.score, 
                                     color = grp_oligo.f, shape=grp_oligo.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm( cex=3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#538533","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Oligo.")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 


###################################
neuron1 <- ca_long_ex3 %>% filter(CellType=="Neuron") 

p_neuron <- ggplot(data=neuron1, aes(x = grp_neuron.f, y = z.score, 
                                     color = grp_neuron.f, shape=grp_neuron.f)) +
  geom_boxplot(width=0.6) + 
  geom_beeswarm(cex = 3) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  scale_color_manual(values=c("#55c056","#00BFC4","#b90f38"))+
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  labs(y="Z-score",x=NULL,title="Neuron")+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=15,face="bold",angle=30,hjust=1),
        axis.text.y = element_text(size=15, face="bold"),
        axis.title=element_text(size=15,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        plot.title = element_text(face= "bold",size=15,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 

###################################
#output graphs

remove_y <- theme(
  axis.text.y = element_blank(),
  #axis.ticks.y = element_blank(),
  axis.title.y = element_blank())

pbox2 <- list(p_coad,
             p_stad + remove_y, 
             p_ov + remove_y,
             p_oligo + remove_y, 
             p_neuron + remove_y)

pbox2_m <- ggarrange(plotlist = pbox2, nrow = 1, 
                    common.legend = F, legend= NULL,  widths = c(1.4, 1.1,1.1, 1.1,1.1)) 
pbox2_m
```

# Extended Data Fig., 
##All boxplots of z-scores, remove negative control background

```{r all cts}

ct_all <- names(unlist(table(ca_long2_csf$CellType)))

blk <- data.frame()
for(i in 1:length(ct_all)){
  ca_long_ex <- ca_long2_csf[,c("CellType","sample_id","BF_id","value")] %>% 
  filter(CellType==ct_all[i]) %>%
  rowwise()%>%
  mutate(control_mean=res_csf_neg.filter[res_csf_neg.filter$CellType==ct_all[i],"mean"],
         control_std=res_csf_neg.filter[res_csf_neg.filter$CellType==ct_all[i],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score")]

  blk <- rbind(blk, ca_long_ex)
}

a <- blk$z.score
ca_long_zscore <- cbind(blk[,c("CellType","BF_id","value")],a)
colnames(ca_long_zscore) <- c("CellType","BF_id","value","z.score")

ca_long_zscore2 <- merge(ca_long_zscore,samp_csf_ca[,c("BF_id","Diag_TCGA")])
ca_long_zscore2 <- ca_long_zscore2 %>% 
  mutate(Diag_TCGA1 = ifelse(Diag_TCGA %in% c("MCF GBM","MCF IDH GLM","MCF MB G3G4"),
                             "Brain",(ifelse(Diag_TCGA=="OV","OV/UCS",Diag_TCGA))))

col_code1 <- c("BRCA"="#b90f38","COAD"="#ad6ef1",
        "DLBC"="#e4703a","LUAD"="#b890e0","Brain"="#55c056", 
        "STAD"="#f79246","OV/UCS"="#6da7d9")

p_all1 <- ggplot(data=ca_long_zscore2, aes(x = Diag_TCGA1, y = z.score, 
                                     color = Diag_TCGA1)) +
  geom_boxplot() + 
  ggbeeswarm::geom_beeswarm(cex =0.8, size =0.5) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  #scale_color_brewer(palette="Set1")+
  scale_colour_manual(values = col_code1) +
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  facet_wrap(~ CellType, ncol = 4) +
  labs(y="Z-score",x=NULL)+
   theme(panel.background = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=10.5,face="bold",angle=90,hjust=1,vjust=0.5),
        axis.text.y = element_text(size=12, face="bold"),
        axis.title=element_text(size=12,face="bold"),
        legend.position="none",
        legend.title=element_blank()) 
p_all1

```

# Extended Data Fig., 
##All boxplots of z-scores, change background to non-target cancers

```{r boxplots_ref.non-target.cancer }

cnv_neg <- 
  samp_csfm[samp_csfm$WGS_CNV_call=="-" & samp_csfm$Diag_TCGA!="Control","BF_id"] #3
luad_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="LUAD","BF_id"] #20
brca_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="BRCA","BF_id"] #6
lympho_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="DLBC","BF_id"] #21
lympho_id2 <- 
  samp_csfm[samp_csfm$Diag_TCGA=="DLBC" & samp_csfm$WGS_CNV_call=="+","BF_id"] #18

coad_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="COAD","BF_id"] #1
stad_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="STAD","BF_id"]#1
ov_id <- 
  samp_csfm[samp_csfm$Diag_TCGA=="OV","BF_id"]#1
oligo_id <- 
  samp_csfm[samp_csfm$Diag_TCGA %in% c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"] #6
neuron_id <- 
  samp_csfm[samp_csfm$Diag_TCGA %in% c("MCF GBM", "MCF IDH GLM", "MCF MB G3G4"),"BF_id"] #6

table(samp_csfm$Diag_TCGA)

samp_res_csf.ca <- samp_csfm[samp_csfm$Diag_TCGA!="Control",]
ca_long2_csf <- ca_long2[ca_long2$BF_id %in% samp_res_csf.ca$BF_id,]

ct=c("Breast-Luminal-Ep","Lung-Ep-Alveo","Blood-B","Colon-Ep","Gastric-Ep",
     "Ovary-Ep","Oligodend","Neuron")


#FUNCTION to get z-scores  
zscore_ref.nontargetCan <- function(ct_all, id_list, can_tp){
blk <- data.frame()
for(i in 1:length(ct_all)){
  
ref_names <- 
  as.vector(samp_res_csf.ca[!samp_res_csf.ca$BF_id %in% id_list, "sample_id"])

ref_use <-subset(res_csf_ca2, select=c("CellType",ref_names))

ref_use$mean <- rowMeans(ref_use[,-1])
ref_use$std <- apply(ref_use[,-1], 1,sd)

  ca_long_ex <- ca_long2_csf[,c("CellType","sample_id","BF_id","value")] %>% 
  filter(CellType==ct_all[i]) %>%
  rowwise()%>%
  mutate(control_mean=ref_use[ref_use$CellType==ct_all[i],"mean"],
         control_std=ref_use[ref_use$CellType==ct_all[i],"std"],
         z.score=round((value - control_mean)/control_std,3))
  
  ca_long_ex <- ca_long_ex[,c("CellType","BF_id","value","z.score")]

a <- ca_long_ex$z.score
ca_long_ex2 <- cbind(ca_long_ex[,c("CellType","BF_id","value")],a)
colnames(ca_long_ex2) <- c("CellType","BF_id","value","z.score")
ca_long_ex2$grp <- 
  ifelse(ca_long_ex2$BF_id %in% id_list,
         can_tp,paste0("Non-",can_tp))

ca_long_ex3 <- ca_long_ex2[ca_long_ex2$BF_id %in% id_list,]


blk <- rbind(blk, ca_long_ex3)
}
return(blk)
}

luad_df <- zscore_ref.nontargetCan(ct_all, id_list=luad_id, can_tp="LUAD")
brca_df <- zscore_ref.nontargetCan(ct_all, id_list=brca_id, can_tp="BRCA")
lympho_df <- zscore_ref.nontargetCan(ct_all, id_list=lympho_id, can_tp="DLBC")
coad_df <- zscore_ref.nontargetCan(ct_all, id_list=coad_id, can_tp="COAD")
neuron_df <- zscore_ref.nontargetCan(ct_all, id_list=neuron_id, can_tp="Brain")
stad_df <- zscore_ref.nontargetCan(ct_all, id_list=stad_id, can_tp="STAD")
ov_df <- zscore_ref.nontargetCan(ct_all, id_list=ov_id, can_tp="OV")

m_df <- rbind(luad_df,brca_df,lympho_df,coad_df,neuron_df,stad_df,ov_df)
m_df$grp <- ifelse(m_df$grp=="OV","OV/UCS",m_df$grp)

col_code2 <- c("BRCA"="#b90f38","COAD"="#ad6ef1",
        "DLBC"="#e4703a","LUAD"="#b890e0","Brain"="#55c056", 
        #"MCF IDH GLM"="#ecbf00", "MCF MB G3G4"="#0581be",
        "STAD"="#f79246","OV/UCS"="#6da7d9")

p_all2 <- ggplot(data=m_df, aes(x = grp, y = z.score, 
                                     color = grp)) +
  geom_boxplot() + 
  ggbeeswarm::geom_beeswarm(cex =0.8, size =0.5) +
  geom_hline(yintercept=-3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=3,color = "grey80", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=-2,color = "grey30", linetype="dashed", linewidth=0.5)+
  geom_hline(yintercept=2,color = "grey30", linetype="dashed", linewidth=0.5)+
  #scale_color_brewer(palette="Set1")+
  scale_colour_manual(values = col_code2) +
  scale_y_continuous(breaks=seq(-10,40, by = 10),
                     labels=seq(-10,40, by = 10),
                     limits=c(-10,40)) +
  facet_wrap(~ CellType, ncol = 4) +
  labs(y="Z score",x=NULL)+
   theme(panel.background = element_blank(),
        #panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "grey80",
                                          linewidth = 0.5,
                                          linetype = 1),
        panel.border = element_rect(color="black",fill=NA),
        #text=element_text(size=15, face="bold"),
        axis.text.x = element_text(size=10.5,face="bold",angle=90,hjust=1,vjust=0.5),
        axis.text.y = element_text(size=12, face="bold"),
        axis.title=element_text(size=12,face="bold"),
        legend.position="none",
        legend.title=element_blank(),
        #plot.title = element_text(face= "bold",size=12,hjust = 0.5),
        panel.spacing = unit(0.2, "lines")) 
p_all2

```


